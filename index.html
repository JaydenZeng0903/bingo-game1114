<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šä¸»é¡Œ Bingo (å‹åˆ©ç›®æ¨™ä¿®æ­£ç‰ˆ)</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Inter å­—é«” -->
    <style>
        @import url('https://fonts.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@300;500;700&display=swap');
        body {
            /* ä½¿ç”¨ Noto Sans TC ç¢ºä¿ä¸­æ–‡é¡¯ç¤ºå„ªè‰¯ */
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8; /* æ·ºè—è‰²èƒŒæ™¯ï¼Œè¦–è¦ºæ›´èˆ’é© */
            min-height: 100vh;
        }
        /* èª¿æ•´ç‚º 4x4 ç¶²æ ¼ */
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
        }
        .grid-cell {
            border: 1px solid #cbd5e1; /* é‚Šæ¡†æ›´æŸ”å’Œ */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 8px; /* å¢åŠ å…§é‚Šè· */
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            line-height: 1.4;
            font-size: 0.875rem; /* é è¨­ text-sm */
            overflow: hidden; 
            min-height: 80px; /* å¢åŠ æœ€å°é«˜åº¦ */
            background-color: white;
            color: #334155; /* æ·±ç°è—è‰² */
            font-weight: 500;
        }
        @media (min-width: 640px) {
            .grid-cell {
                font-size: 1rem; /* sm:text-base */
                padding: 12px;
            }
        }
        .marked {
            background-color: #1d4ed8 !important; /* æ·±è—è‰² */
            color: white !important;
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(29, 78, 216, 0.4);
        }
        .winning {
            background-color: #10b981 !important;
            animation: pulse-green 1s infinite alternate;
        }
        @keyframes pulse-green {
            from { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            to { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        }
        
        /* Selection UI - èª¿æ•´ç‚ºæ›´åƒæŒ‰éˆ• */
        .selection-item {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 50px; /* å¢åŠ é»æ“Šå€åŸŸ */
            font-weight: 600;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-size: 0.875rem; /* ä¿æŒ text-sm */
        }
        .custom-item {
            background-color: #fcd34d !important; /* é®®è±”é»ƒè‰² */
            color: #92400e !important;
            border-color: #fbbd24 !important;
        }
        .custom-selected {
            background-color: #d97706 !important; /* æ·±æ©˜è‰² */
            color: white !important;
            border-color: #d97706 !important;
        }
        .selected {
            background-color: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
        }
        
        /* Modal Styles - ç¢ºä¿æ‰‹æ©Ÿé«”é©— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px; /* å¢åŠ é‚Šè·é˜²æ­¢è²¼é‚Š */
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* ç¦ç”¨é¸å–®æ¨£å¼ */
        select:disabled {
            background-color: #e2e8f0; /* æ·ºç°è‰²èƒŒæ™¯ */
            color: #64748b; /* æ·±ç°è‰²å­—é«” */
            cursor: not-allowed;
            border-color: #94a3b8;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-xl mx-auto bg-white rounded-2xl shadow-2xl p-6 sm:p-8 border border-gray-100">
        
        <h1 id="theme-title" class="text-3xl font-extrabold text-center text-blue-700 mb-2">
            Bingo éŠæˆ²
        </h1>
        <p class="text-center text-gray-500 mb-6 text-sm">
            é»æ“Šæ ¼å­å³å¯æ¨™è¨˜/å–æ¶ˆæ¨™è¨˜ã€‚
        </p>

        <!-- ä¸»é¡Œèˆ‡ç·šæ•¸é¸æ“‡å€å¡Š (éŸ¿æ‡‰å¼ Flex) -->
        <div class="space-y-3 mb-6">
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                <!-- ä¸»é¡Œé¸æ“‡ -->
                <div class="flex-1">
                    <label for="theme-selector" class="block text-sm font-medium text-gray-700 mb-1">
                        ä¸»é¡Œï¼š
                    </label>
                    <select id="theme-selector" onchange="changeTheme(this.value)" class="w-full p-2 border border-gray-300 rounded-lg shadow-md focus:ring-blue-500 focus:border-blue-500 transition">
                        <!-- Options will be added by JS -->
                    </select>
                </div>
                
                <!-- å‹åˆ©ç·šæ•¸é¸æ“‡ -->
                <div class="flex-none w-full sm:w-auto">
                    <label for="lines-needed-selector" class="block text-sm font-medium text-gray-700 mb-1">
                        å‹åˆ©ç›®æ¨™ï¼š
                    </label>
                    <select id="lines-needed-selector" onchange="handleLinesNeededChange(this.value)" class="w-full p-2 border border-blue-400 rounded-lg shadow-md focus:ring-blue-500 focus:border-blue-500 bg-blue-50 transition">
                        <!-- Options 1 to 10 will be generated by JS -->
                    </select>
                </div>
            </div>
            <!-- 
              ä¿®æ­£ï¼šç§»é™¤ inline onclick="quickStartGame()"
              äº‹ä»¶å°‡ç”± JavaScript åœ¨ initApp ä¸­ç¶å®š 
            -->
            <button id="quick-start-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-150 transform hover:scale-[1.03] mt-4 disabled:bg-purple-300 disabled:shadow-none">
                ğŸš€ å¿«é€Ÿé–‹å§‹ (ç³»çµ±éš¨æ©Ÿ 4x4)
            </button>
        </div>
        
        <!-- è¨Šæ¯å€å¡Š -->
        <div id="message-box" class="p-4 mb-6 rounded-xl border-l-4 hidden" role="alert">
            <p id="message-text" class="font-medium text-sm sm:text-base"></p>
        </div>
        
        <!-- 30 é¸ 16 é¸æ“‡ä»‹é¢ -->
        <div id="selection-area" class="space-y-4 hidden">
            <h2 class="text-xl font-bold text-gray-700 border-b pb-2">ğŸ¯ é¸æ“‡æ‚¨çš„ 16 å€‹æ ¼å­å…§å®¹</h2>
            <!-- 
              ä¿®æ­£ï¼šæ–°å¢ ID "selection-prompt-text" ä¸¦ç§»é™¤ç¡¬ç·¨ç¢¼çš„ "31" 
              å…§å®¹å°‡ç”± renderSelectionUI() å‹•æ…‹å¡«å…¥
            -->
            <p id="selection-prompt-text" class="text-sm text-gray-500">
                <!-- JS will populate this text -->
            </p>
            <!-- é¸æ“‡æ± ï¼šæ‰‹æ©Ÿ 3 æ¬„ï¼Œå¹³æ¿/æ¡Œé¢ 4-5 æ¬„ -->
            <div id="selection-pool" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 p-4 bg-gray-100 rounded-xl border border-gray-200">
                <!-- Selectable items go here -->
            </div>
            
            <!-- åº•éƒ¨ç‹€æ…‹èˆ‡æŒ‰éˆ• -->
            <div class="flex flex-col space-y-3 justify-between items-center pt-4 border-t mt-4">
                <p class="text-xl font-bold text-blue-600">å·²é¸æ“‡ï¼š<span id="selected-count">0</span> / 16</p>
                <button id="start-game-button" onclick="finalizeGrid()" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-150 transform hover:scale-[1.03] disabled:bg-green-300 disabled:shadow-none">
                    é–‹å§‹éŠæˆ² (ç¢ºå®š 4x4 è¡¨æ ¼)
                </button>
            </div>
        </div>

        <!-- éŠæˆ²å€ -->
        <div id="game-area" class="space-y-6 hidden">
            
            <!-- ç‹€æ…‹é¡¯ç¤ºå€å¡Š -->
            <div id="current-player-status" class="text-center text-lg font-bold text-blue-800 bg-blue-100 p-3 rounded-xl shadow-inner">
                ç•¶å‰ç‹€æ…‹ï¼šå·²æ¨™è¨˜ <span id="mark-count" class="text-2xl font-extrabold text-blue-600">0</span> æ ¼
            </div>

            <!-- Bingo å¡ç‰‡ç¶²æ ¼ (ç¾åœ¨æ˜¯ 4x4) -->
            <div id="bingo-grid-container" class="bingo-grid w-full bg-white rounded-xl overflow-hidden shadow-2xl border-4 border-blue-500">
                <!-- 4x4 Grid Cells will be inserted here by JavaScript -->
            </div>
            
            <button onclick="showResetConfirmation()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-150 transform hover:scale-[1.01] mt-4">
                ğŸ—‘ï¸ é‡è¨­éŠæˆ² (æ¸…é™¤è¡¨æ ¼èˆ‡é€²åº¦)
            </button>
        </div>
    </div>
    
    <!-- é‡è¨­ç¢ºèªè¦–çª— (Custom Modal) -->
    <div id="reset-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 class="text-2xl font-bold text-red-600 mb-4">âš ï¸ ç¢ºèªé‡è¨­éŠæˆ²</h3>
            <p class="text-gray-700 mb-6">
                æ‚¨ç¢ºå®šè¦é‡è¨­éŠæˆ²å—ï¼Ÿé€™å°‡æœƒ<strong class="text-red-600 font-bold">æ¸…é™¤æ‚¨å„²å­˜åœ¨ç€è¦½å™¨ä¸­çš„æ‰€æœ‰é€²åº¦ã€‚</strong>
            </p>
            <div class="flex justify-center space-x-4">
                <button onclick="hideResetConfirmation()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full transition duration-150 shadow-md">
                    å–æ¶ˆ
                </button>
                <button onclick="executeResetGame()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full shadow-md transition duration-150">
                    ç¢ºå®šé‡è¨­
                </button>
            </div>
        </div>
    </div>
    
    <!-- è‡ªè¨‚å…§å®¹è¼¸å…¥è¦–çª— (Custom Modal) -->
    <div id="custom-content-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-blue-600 mb-4">âœï¸ è¼¸å…¥è‡ªè¨‚æ ¼å­å…§å®¹</h3>
            <p class="text-gray-700 mb-4">è«‹ç‚ºæ‚¨é¸æ“‡çš„è‡ªè¨‚é …ç›®è¼¸å…¥å…§å®¹ (ä¾‹å¦‚: æ›¾åœ¨æ©Ÿå ´ç´„æœƒ)</p>
            <input type="text" id="custom-content-input" maxlength="15" placeholder="è¼¸å…¥å…§å®¹ (é™ 15 å­—)" class="w-full p-3 border border-gray-300 rounded-lg mb-6 shadow-inner focus:ring-blue-500 focus:border-blue-500" />
            <div class="flex justify-end space-x-4">
                <button onclick="cancelCustomContent()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full transition duration-150">
                    å–æ¶ˆ
                </button>
                <button onclick="confirmCustomContent()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-md transition duration-150">
                    ç¢ºå®š
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- éœæ…‹æ•¸æ“šï¼šæ‰€æœ‰ä¸»é¡Œå®šç¾© ---
        const THEMES = {
            'couple': {
                title: "å¤«å¦»ç‰ˆ - ç ´å†°éŠæˆ² (æ—¥å¸¸æƒ…å¢ƒ)",
                // æ“´å……åˆ° 30 å€‹é¸é …
                items: [
                    "æ¯æ™šç¡å‰æœƒäº’é“æ™šå®‰", "çŸ¥é“å°æ–¹æ‰‹æ©Ÿé›»é‡ä½æ–¼å¤šå°‘æœƒç„¦æ…®", "æ›¾ç‚ºäº†ã€Œèª°æ´—ç¢—ã€ç©çŒœæ‹³æ±ºå®š", "è‡³å°‘ç‚ºå°æ–¹è²·éäº”æ¬¡å¤–è³£/å¤–é€", "åœ¨å°æ–¹ç”Ÿç—…æ™‚ç…§é¡§éå°æ–¹",
                    "ä¸€èµ·çµ„è£é IKEA æˆ–å¤§å‹å®¶å…·", "æ›¾å› å†·æ°£æº«åº¦é–‹å¤ªä½çˆ­åŸ·", "ç¡è¦ºæ™‚è¢«å°æ–¹æ¶èµ°æ£‰è¢«", "åœ¨å®¶ç©¿è‘—å°æ–¹çš„èˆŠè¡£æœ", "çŸ¥é“å°æ–¹æœ€æ„›åƒçš„å®µå¤œæ˜¯ä»€éº¼",
                    "æ—©ä¸Šèµ·ä¾†ç™¼ç¾å°æ–¹æŠŠç‰™è†æ“ å®Œäº†", "æ›¾åœ¨å…¬å…±å ´åˆçµ¦éå°æ–¹ã€Œçœ¼ç¥è­¦å‘Šã€", "çˆ­åµå¾Œéš”å¤©æ—©ä¸Šæœƒä¸»å‹•å’Œå¥½", "å…©äººéƒ½æœ‰æˆ´çœ¼é¡æˆ–éš±å½¢çœ¼é¡", "æ›¾ç¶“å¹«å°æ–¹ä¿®å‰ªéé ­é«®",
                    "è¼ªæµå€’åƒåœ¾è¶…éåŠå¹´", "äº’ç›¸çŸ¥é“å°æ–¹çš„ã€Œå°·å°¬å¾€äº‹ã€", "æ›¾ç‚ºäº†å½±é›†æˆ–é›»å½±çš„çµå±€åµæ¶", "ä¿ç•™è‘—å°æ–¹å¯«çµ¦è‡ªå·±çš„ç¬¬ä¸€å¼µå¡ç‰‡", "æ›¾åœ¨å°æ–¹æ‰‹æ©Ÿè£¡å­˜äº†æç¬‘ç…§ç‰‡",
                    "æ›¾å› è¦åŠƒæ—…éŠè¡Œç¨‹æ„è¦‹ä¸åˆ", "å…±åŒå®Œæˆéä¸€æ¬¡å¤§æƒé™¤", "å©šå¾Œä»å …æŒå„ç”¨å„çš„éŒ¢åŒ…/å¸³æˆ¶", "æ›¾ä¸€èµ·åœ¨æ·±å¤œè¶•å ±å‘Š/å·¥ä½œ", "æ›¾ç¶“åœ¨ä¸‰å€‹æœˆå…§æ¬éå®¶",
                    // æ–°å¢ 5 å€‹æ›´ç”Ÿæ´»åŒ–çš„é¸é …
                    "æ›¾å› ç‚ºå«éŒ¯å°æ–¹çš„åå­—è€Œè¢«çª", "è‡³å°‘ä¸€æ¬¡åœ¨å°æ–¹ç¡è‘—å¾Œå·æ‹éç…§ç‰‡", "ç‚ºäº†è¦ä¸è¦é¤Šå¯µç‰©è¨è«–è¶…éä¸€å€‹æœˆ", "å·å·æŠŠå°æ–¹ä¸å–œæ­¡åƒçš„é£Ÿæå¾é¤ç›¤ä¸Šå¤¾èµ°", "æ›¾é€£çºŒä¸‰å¤©æ™šä¸Šä¸€èµ·çœ‹åŒä¸€éƒ¨é›»å½±/åŠ‡é›†"
                    ,
                    // <-- æ–°å¢çš„ 10 å€‹é …ç›® -->
                    "æ›¾ä¸€èµ·çœ‹æ—¥å‡ºæˆ–æ—¥è½",
                    "æ‰‹æ©Ÿè£¡æœ‰å°æ–¹çš„å°ˆå±¬æš±ç¨±",
                    "åµæ¶æ™‚ï¼Œå°æ–¹æœƒå…ˆå»æ³¡ä¸€æ¯é£²æ–™",
                    "ä¸€èµ·å»é€›éå¤œå¸‚ï¼Œä¸¦åˆ†äº«åŒä¸€ä»½å°åƒ",
                    "çŸ¥é“å°æ–¹éŠ€è¡Œå¡å¯†ç¢¼ï¼ˆæˆ–å…¶ä¸­ä¸€å¼µï¼‰",
                    "æ›¾ä¸€èµ·æ·‹éé›¨",
                    "å®¶è£¡æœ‰ä¸æˆæ–‡çš„ã€Œæš—è™Ÿã€æˆ–ã€Œè¡“èªã€",
                    "æ›¾å¹«å°æ–¹æ‹”éç™½é ­é«®æˆ–æ“ ç—˜ç—˜",
                    "å…©äººæœ‰å…±åŒçš„å„²è“„ç›®æ¨™",
                    "è‡³å°‘ç©¿éä¸€æ¬¡æƒ…ä¾¶è£ï¼ˆæˆ–é¡ä¼¼è¡£ç‰©ï¼‰"
                    // <-- æ–°å¢é …ç›®çµæŸ -->
                ]
            },
            'bible': {
                title: "è–ç¶“äººç‰©ç‰ˆ - ç ´å†°éŠæˆ²",
                items: [
                    "æŒªäº", "äºä¼¯æ‹‰ç½•", "æ‘©è¥¿", "ç´„æ›¸äº", "å¤§è¡›",
                    "æ‰€ç¾…é–€", "ä»¥è³½äº", "è€¶åˆ©ç±³", "ä½†ä»¥ç†", "ç´„æ‹¿",
                    "æ–½æ´—ç´„ç¿°", "å½¼å¾—", "ä¿ç¾…", "ææ‘©å¤ª", "é¦¬åˆ©äº (è€¶ç©Œä¹‹æ¯)",
                    "é¦¬å¤§", "è·¯å¾—", "ä»¥æ–¯å¸–", "é›…å„", "ä»¥æ’’",
                    "åƒå­«", "æ’’æ¯è€³", "ä»¥åˆ©äº", "ç´„ä¼¯", "å¤šé¦¬",
                    // ç‚ºäº†é”åˆ° 30 é¸ 16 çš„ç›®æ¨™ï¼Œéœ€è¦è£œè¶³é¸é …
                    "è©²éš±", "äºä¼¯", "ç´„ç‘Ÿ", "åº•æ³¢æ‹‰", "åŸºç”¸"
                ]
            }
        };
        
        // Global constant for all 4x4 winning combinations (10 in total)
        const WIN_COMBINATIONS_4X4 = [
            // æ©«ç·š (Rows)
            [0, 1, 2, 3], [4, 5, 6, 7], [8, 9, 10, 11], [12, 13, 14, 15],
            // ç›´ç·š (Columns)
            [0, 4, 8, 12], [1, 5, 9, 13], [2, 6, 10, 14], [3, 7, 11, 15],
            // å°è§’ç·š (Diagonals)
            [0, 5, 10, 15], [3, 6, 9, 12]
        ];

        // --- å¸¸æ•¸å’Œé è¨­å€¼ ---
        const LOCAL_ACTIVE_THEME_KEY = 'local_active_theme';
        const LOCAL_SQUARES_KEY = 'local_player_squares_indices_'; 
        const LOCAL_MARKS_KEY = 'local_player_marks_'; 
        const LOCAL_CUSTOM_CONTENT_KEY = 'local_custom_content_'; 
        const LOCAL_LINES_NEEDED_KEY = 'local_lines_needed_'; 
        const CUSTOM_ITEM_PLACEHOLDER = 'CUSTOM_ITEM_SLOT'; 
        
        // --- æ ¸å¿ƒç‹€æ…‹ ---
        let activeTheme = loadState(LOCAL_ACTIVE_THEME_KEY) || 'couple';
        let playerSquaresIndices = null; 
        let marks = []; 
        let customContent = ''; 
        let tempSelections = []; 
        let bingoLinesNeeded = 1; 
        
        // UI å…ƒç´ 
        const themeSelector = document.getElementById('theme-selector');
        const themeTitle = document.getElementById('theme-title');
        const selectionAreaDiv = document.getElementById('selection-area');
        const gameAreaDiv = document.getElementById('game-area');
        const selectionPoolDiv = document.getElementById('selection-pool');
        const selectedCountSpan = document.getElementById('selected-count');
        const startGameButton = document.getElementById('start-game-button');
        const bingoGridContainer = document.getElementById('bingo-grid-container');
        const markCountDisplay = document.getElementById('mark-count');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const customContentModal = document.getElementById('custom-content-modal');
        const customContentInput = document.getElementById('custom-content-input');
        const resetModal = document.getElementById('reset-modal');
        const linesNeededSelector = document.getElementById('lines-needed-selector');
        const quickStartButton = document.getElementById('quick-start-button'); // <-- æ–°å¢

        
        // --- è¼”åŠ©/å„²å­˜å‡½å¼ ---

        function loadState(key) {
            try {
                const json = localStorage.getItem(key);
                return json ? JSON.parse(json) : null;
            } catch (e) {
                console.error(`Error loading state for key ${key}:`, e);
                return null;
            }
        }

        function saveState(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Error saving state for key ${key}:`, e);
            }
        }

        function showMessage(text, type = 'warning') {
            messageText.textContent = text;
            messageBox.className = 'p-4 mb-6 rounded-xl border-l-4';
            messageBox.classList.remove('hidden', 'bg-red-100', 'border-red-500', 'text-red-700', 'bg-green-100', 'border-green-500', 'text-green-700', 'bg-yellow-100', 'border-yellow-500', 'text-yellow-700');
            
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
            } else {
                messageBox.classList.add('bg-yellow-100', 'border-yellow-500', 'text-yellow-700');
            }
            messageBox.classList.remove('hidden');
        }

        // --- é–å®š/è§£é–æ§åˆ¶é …çš„å‡½å¼ ---
        function disableSelectors() {
            themeSelector.disabled = true;
            linesNeededSelector.disabled = true;
            if (quickStartButton) quickStartButton.disabled = true; // <-- æ–°å¢
        }

        function enableSelectors() {
            themeSelector.disabled = false;
            linesNeededSelector.disabled = false;
            if (quickStartButton) quickStartButton.disabled = false; // <-- æ–°å¢
        }
        
        // --- ä¸»é¡Œåˆ‡æ›é‚è¼¯ ---
        
        function loadCurrentThemeState() {
            playerSquaresIndices = loadState(LOCAL_SQUARES_KEY + activeTheme) || null;
            marks = loadState(LOCAL_MARKS_KEY + activeTheme) || [];
            customContent = loadState(LOCAL_CUSTOM_CONTENT_KEY + activeTheme) || '';
            // è¼‰å…¥å‹åˆ©ç·šæ•¸ï¼Œå¦‚æœæ²’æœ‰å‰‡é è¨­ç‚º 1
            bingoLinesNeeded = loadState(LOCAL_LINES_NEEDED_KEY + activeTheme) || 1; 
            tempSelections = playerSquaresIndices || [];
        }
        
        function saveCurrentThemeState() {
            saveState(LOCAL_ACTIVE_THEME_KEY, activeTheme);
            saveState(LOCAL_SQUARES_KEY + activeTheme, playerSquaresIndices);
            saveState(LOCAL_MARKS_KEY + activeTheme, marks);
            saveState(LOCAL_CUSTOM_CONTENT_KEY + activeTheme, customContent);
            saveState(LOCAL_LINES_NEEDED_KEY + activeTheme, bingoLinesNeeded); 
        }

        window.changeTheme = function(newTheme) {
            if (themeSelector.disabled) {
                showMessage('éŠæˆ²å·²é–‹å§‹ï¼Œç„¡æ³•è®Šæ›´ä¸»é¡Œã€‚è«‹é‡è¨­éŠæˆ²å¾Œå†ä¿®æ”¹ã€‚', 'error');
                themeSelector.value = activeTheme; // Revert selection
                return;
            }

            if (newTheme === activeTheme) return;
            activeTheme = newTheme;
            saveState(LOCAL_ACTIVE_THEME_KEY, newTheme);
            
            loadCurrentThemeState();
            
            showMessage(`ä¸»é¡Œå·²åˆ‡æ›åˆ°ã€Œ${THEMES[activeTheme].title}ã€ã€‚`, 'success');
            
            initApp(); 
        }

        function shuffleArray(array) {
            let arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function checkWin(currentMarks) {
            const markedIndices = new Set(currentMarks);
            let completedCombos = [];
            let winningIndices = new Set();

            for (const combo of WIN_COMBINATIONS_4X4) {
                if (combo.every(index => markedIndices.has(index))) {
                    completedCombos.push(combo);
                    combo.forEach(index => winningIndices.add(index));
                }
            }
            
            return {
                count: completedCombos.length,
                winningIndices: Array.from(winningIndices),
                isBingo: completedCombos.length > 0
            };
        }

        window.handleLinesNeededChange = function(value) {
            if (linesNeededSelector.disabled) {
                showMessage('éŠæˆ²å·²é–‹å§‹ï¼Œç„¡æ³•è®Šæ›´å‹åˆ©ç›®æ¨™ã€‚è«‹é‡è¨­éŠæˆ²å¾Œå†ä¿®æ”¹ã€‚', 'error');
                linesNeededSelector.value = bingoLinesNeeded; // Revert selection
                return;
            }
            
            const newLines = parseInt(value, 10);
            if (newLines >= 1 && newLines <= 10) {
                bingoLinesNeeded = newLines;
                saveCurrentThemeState();
                showMessage(`ç²å‹ç›®æ¨™å·²è¨­å®šç‚ºå®Œæˆ ${bingoLinesNeeded} æ¢ç·šï¼`, 'warning');
            }
        }
        
        /**
         * æ¸²æŸ“å‹åˆ©ç›®æ¨™ä¸‹æ‹‰é¸å–® (1åˆ°10æ¢ç·š)
         */
        function renderLinesNeededSelector() {
            linesNeededSelector.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i} æ¢ç·š (${i === 10 ? 'å…¨æ»¿' : ''})`;
                linesNeededSelector.appendChild(option);
            }
            // ç¢ºä¿é¸å–®çš„å€¼èˆ‡ç•¶å‰ç‹€æ…‹åŒæ­¥
            linesNeededSelector.value = bingoLinesNeeded;
        }


        // --- éŠæˆ²é‚è¼¯èˆ‡ UI æ¸²æŸ“ ---

        function renderBingoGrid() {
            const BINGO_ITEMS = THEMES[activeTheme].items;
            
            if (!playerSquaresIndices || playerSquaresIndices.length !== 16) {
                renderSelectionUI();
                return;
            }

            // éŠæˆ²é–‹å§‹å¾Œï¼Œé–å®šé¸æ“‡å™¨
            disableSelectors();

            // éŠæˆ²ä¸­ä¹Ÿè¦ç¢ºä¿ç›®æ¨™é¡¯ç¤ºæ­£ç¢º
            renderLinesNeededSelector();

            selectionAreaDiv.classList.add('hidden');
            gameAreaDiv.classList.remove('hidden');

            const winResult = checkWin(marks);
            const completedLinesCount = winResult.count;
            
            const isGameWon = completedLinesCount >= bingoLinesNeeded; 
            
            if (isGameWon) {
                showMessage(`ğŸ‰ æ­å–œæ‚¨ï¼å·²å®Œæˆ ${completedLinesCount} æ¢ç·šï¼Œé”æˆ ${bingoLinesNeeded} æ¢ç·šçš„å‹åˆ©ç›®æ¨™ï¼`, 'success');
            } else if (completedLinesCount > 0) {
                showMessage(`å·²å®Œæˆ ${completedLinesCount} æ¢ç·šã€‚é‚„éœ€è¦ ${bingoLinesNeeded - completedLinesCount} æ¢ç·šæ‰èƒ½ç²å‹ï¼`, 'warning');
            } else {
                messageBox.classList.add('hidden');
            }
            
            bingoGridContainer.innerHTML = '';
            const winningIndices = new Set(winResult.winningIndices);

            playerSquaresIndices.forEach((poolId, index) => {
                let itemText;
                const isCustom = poolId === CUSTOM_ITEM_PLACEHOLDER;
                if (isCustom) {
                    itemText = customContent || '[è‡ªè¨‚å…§å®¹æœªè¨­å®š]'; 
                } else {
                    itemText = BINGO_ITEMS[poolId];
                }

                const isMarked = marks.includes(index);
                const isWinningCell = winningIndices.has(index); 
                
                const cell = document.createElement('div');
                cell.className = `grid-cell rounded-lg transition duration-100 ${isMarked ? 'marked' : 'bg-white hover:bg-blue-50'} ${isWinningCell && isGameWon ? 'winning' : ''} ${isCustom ? 'border-dashed border-2 border-orange-400' : ''}`;
                cell.textContent = itemText;
                cell.dataset.index = index;
                cell.onclick = () => handleCellClick(index);
                
                bingoGridContainer.appendChild(cell);
            });
            
            markCountDisplay.textContent = marks.length;
        }
        
        window.handleCellClick = function(index) {
            const BINGO_ITEMS = THEMES[activeTheme].items;
            const markIndex = marks.indexOf(index); 
            
            let itemText;
            const poolId = playerSquaresIndices[index];
            if (poolId === CUSTOM_ITEM_PLACEHOLDER) {
                itemText = customContent || '[è‡ªè¨‚å…§å®¹]';
            } else {
                itemText = BINGO_ITEMS[poolId] || '[æœªçŸ¥é …ç›®]';
            }

            if (markIndex === -1) {
                marks.push(index);
                showMessage(`æ‚¨æ¨™è¨˜äº† "${itemText}"ã€‚`, 'success');
            } else {
                marks.splice(markIndex, 1);
                showMessage(`æ‚¨å–æ¶ˆäº† "${itemText}" çš„æ¨™è¨˜ã€‚`, 'warning');
            }
            
            saveCurrentThemeState();
            renderBingoGrid(); 
        }


        function renderSelectionUI() {
            const BINGO_ITEMS = THEMES[activeTheme].items;
            const totalPoolSize = BINGO_ITEMS.length + 1; // +1 for custom
            
            // --- ä¿®æ­£ï¼šå‹•æ…‹æ›´æ–°é¸æ“‡æç¤ºæ–‡å­— ---
            const promptTextElement = document.getElementById('selection-prompt-text');
            if (promptTextElement) {
                promptTextElement.innerHTML = `è«‹å¾ä¸‹æ–¹ <strong>${totalPoolSize}</strong> å€‹é …ç›®ä¸­ï¼Œé»æ“Šé¸æ“‡ <strong>16</strong> å€‹é …ç›®ä¾†çµ„æˆæ‚¨å€‹äººçš„ <strong>4x4</strong> Bingo è¡¨æ ¼ã€‚`;
            }
            // --- ä¿®æ­£çµæŸ ---
            
            // éŠæˆ²æœªé–‹å§‹ï¼Œå•Ÿç”¨é¸æ“‡å™¨
            enableSelectors();

            gameAreaDiv.classList.add('hidden');
            selectionAreaDiv.classList.remove('hidden');
            selectionPoolDiv.innerHTML = '';
            messageBox.classList.add('hidden'); 
            
            const fullPool = [...BINGO_ITEMS.map((item, index) => ({ item, id: index })), 
                             { item: '[è‡ªè¨‚ä¸€é …]', id: CUSTOM_ITEM_PLACEHOLDER, isCustom: true }];
            
            fullPool.forEach(({ item, id, isCustom }) => {
                const isSelected = tempSelections.includes(id);

                const itemDiv = document.createElement('div');
                itemDiv.className = `p-2 border rounded-lg text-xs cursor-pointer transition duration-100 selection-item ${
                    isCustom ? 'custom-item' : 'bg-white hover:bg-yellow-100 border-gray-300'
                } ${
                    isSelected ? (isCustom ? 'custom-selected' : 'selected') : ''
                }`;
                itemDiv.textContent = item;
                itemDiv.dataset.poolId = id;
                itemDiv.onclick = () => handleSelectionClick(id, isCustom);
                selectionPoolDiv.appendChild(itemDiv);
            });
            
            if (tempSelections.includes(CUSTOM_ITEM_PLACEHOLDER) && customContent) {
                const customItemElement = selectionPoolDiv.querySelector(`[data-pool-id="${CUSTOM_ITEM_PLACEHOLDER}"]`);
                if (customItemElement) {
                     customItemElement.textContent = `[è‡ªè¨‚ä¸€é …] - "${customContent}"`;
                }
            } else if (tempSelections.includes(CUSTOM_ITEM_PLACEHOLDER) && !customContent) {
                 showMessage('è«‹é»æ“Šã€Œ[è‡ªè¨‚ä¸€é …]ã€æŒ‰éˆ•è¼¸å…¥æ‚¨çš„è‡ªè¨‚å…§å®¹ï¼', 'error');
            }
            
            updateSelectionCountAndButton();
        }

        function updateSelectionCountAndButton() {
            selectedCountSpan.textContent = tempSelections.length;
            const isCustomSelected = tempSelections.includes(CUSTOM_ITEM_PLACEHOLDER);
            
            const canStart = tempSelections.length === 16 && (!isCustomSelected || (isCustomSelected && customContent.trim()));
            startGameButton.disabled = !canStart;
            
            if (tempSelections.length > 16) {
                 showMessage('é¸æ“‡é …ç›®è¶…é 16 å€‹ï¼Œè«‹å–æ¶ˆé¸æ“‡ã€‚', 'error');
            } else if (tempSelections.length === 16 && isCustomSelected && !customContent.trim()) {
                 showMessage('è«‹å…ˆè¼¸å…¥ä¸¦ç¢ºå®šæ‚¨çš„è‡ªè¨‚å…§å®¹ï¼', 'warning');
            } else {
                // Keep other messages if they are currently showing, otherwise hide.
                if (!canStart && tempSelections.length < 16) {
                    messageBox.classList.add('hidden'); 
                }
            }
        }
        
        window.handleSelectionClick = function(id, isCustom) {
            const indexInArray = tempSelections.indexOf(id);

            if (indexInArray === -1) {
                if (tempSelections.length < 16) {
                    tempSelections.push(id);
                    if (isCustom) {
                        customContentInput.value = customContent; 
                        customContentModal.style.display = 'flex';
                    }
                } else {
                    showMessage('æ‚¨å·²ç¶“é¸æ“‡äº† 16 å€‹é …ç›®ã€‚è«‹å–æ¶ˆä¸€å€‹é …ç›®å¾Œå†é¸æ“‡ã€‚', 'warning');
                }
            } else {
                tempSelections.splice(indexInArray, 1);
                if (isCustom) {
                    customContent = ''; 
                    saveCurrentThemeState(); 
                }
            }
            
            renderSelectionUI(); 
        }
        
        window.confirmCustomContent = function() {
            const content = customContentInput.value.trim();
            if (content.length < 2) {
                showMessage('è‡ªè¨‚å…§å®¹è‡³å°‘éœ€è¦ 2 å€‹å­—ã€‚', 'error');
                return;
            }
            customContent = content;
            saveCurrentThemeState();
            customContentModal.style.display = 'none';
            showMessage(`è‡ªè¨‚å…§å®¹ï¼š"${customContent}" å·²å„²å­˜ã€‚è«‹ç¹¼çºŒå®Œæˆ 16 å€‹é …ç›®çš„é¸æ“‡ã€‚`, 'success');
            
            renderSelectionUI(); 
        }

        window.cancelCustomContent = function() {
            customContentModal.style.display = 'none';
            const indexInArray = tempSelections.indexOf(CUSTOM_ITEM_PLACEHOLDER);
            if (indexInArray !== -1) {
                tempSelections.splice(indexInArray, 1);
                customContent = '';
                saveCurrentThemeState();
                renderSelectionUI(); 
                showMessage('å·²å–æ¶ˆè‡ªè¨‚é …ç›®ã€‚', 'warning');
            }
        }

        window.finalizeGrid = function() {
            if (tempSelections.length !== 16) {
                showMessage('è«‹ç¢ºåˆ‡é¸æ“‡ 16 å€‹é …ç›®ï¼', 'error');
                return;
            }
            
            const isCustomSelected = tempSelections.includes(CUSTOM_ITEM_PLACEHOLDER);
            if (isCustomSelected && !customContent.trim()) {
                 showMessage('è«‹å…ˆè¼¸å…¥ä¸¦ç¢ºå®šæ‚¨çš„è‡ªè¨‚å…§å®¹ã€‚', 'error');
                 return;
            }

            playerSquaresIndices = shuffleArray(tempSelections);

            saveCurrentThemeState();
            
            marks = [];
            saveCurrentThemeState();
            
            // éŠæˆ²é–‹å§‹ï¼Œé–å®šé¸æ“‡å™¨
            disableSelectors();

            showMessage('æ‚¨çš„ 4x4 Bingo è¡¨æ ¼å·²å»ºç«‹ï¼é–‹å§‹éŠæˆ²å§ï¼', 'success');
            renderBingoGrid();
        }
        
        window.showResetConfirmation = function() {
            resetModal.style.display = 'flex';
        }

        window.hideResetConfirmation = function() {
            resetModal.style.display = 'none';
        }

        window.executeResetGame = function() {
            hideResetConfirmation(); 
            localStorage.removeItem(LOCAL_SQUARES_KEY + activeTheme);
            localStorage.removeItem(LOCAL_MARKS_KEY + activeTheme);
            localStorage.removeItem(LOCAL_CUSTOM_CONTENT_KEY + activeTheme);
            localStorage.removeItem(LOCAL_LINES_NEEDED_KEY + activeTheme); 
            
            playerSquaresIndices = null;
            marks = [];
            customContent = '';
            tempSelections = [];
            bingoLinesNeeded = 1; 

            // é‡è¨­å¾Œï¼Œå•Ÿç”¨é¸æ“‡å™¨
            enableSelectors();

            showMessage(`ã€Œ${THEMES[activeTheme].title}ã€éŠæˆ²å·²æˆåŠŸé‡è¨­ã€‚è«‹é‡æ–°é¸æ“‡æ‚¨çš„ 16 å€‹æ ¼å­å…§å®¹ã€‚`, 'success');
            renderSelectionUI(); 
            // ç¢ºä¿é‡è¨­å¾Œç›®æ¨™é¸æ“‡å™¨ä¹Ÿèƒ½ç«‹å³æ›´æ–°
            renderLinesNeededSelector();
        }

        // --- æ–°å¢ï¼šå¿«é€Ÿé–‹å§‹éŠæˆ² ---
        // ä¿®æ­£ï¼šç§»é™¤ window. ï¼Œä½¿å…¶æˆç‚ºè…³æœ¬å…§çš„å‡½å¼
        function quickStartGame() {
            const currentThemeItems = THEMES[activeTheme].items;
            
            // æª¢æŸ¥é …ç›®æ˜¯å¦è¶³å¤ 
            if (currentThemeItems.length < 16) {
                showMessage(`ä¸»é¡Œã€Œ${THEMES[activeTheme].title}ã€çš„é …ç›®å°‘æ–¼ 16 å€‹ï¼Œç„¡æ³•å¿«é€Ÿé–‹å§‹ã€‚`, 'error');
                return;
            }

            // å»ºç«‹æ‰€æœ‰å¯ç”¨é …ç›®çš„ç´¢å¼•åˆ—è¡¨ (0 åˆ° length-1)
            // é€™æ¨£åšæœƒè‡ªå‹•å¿½ç•¥ã€Œè‡ªè¨‚ã€é¸é …ï¼Œå› ç‚ºå®ƒä¸åœ¨ items é™£åˆ—ä¸­
            const itemIndices = Array.from({ length: currentThemeItems.length }, (_, i) => i);

            // æ´—ç‰Œç´¢å¼•
            const shuffledIndices = shuffleArray(itemIndices);

            // é¸å–å‰ 16 å€‹ä½œç‚ºæ ¼å­å…§å®¹
            playerSquaresIndices = shuffledIndices.slice(0, 16);

            // é‡è¨­æ¨™è¨˜
            marks = [];
            
            // å„²å­˜ç‹€æ…‹ (å„²å­˜æ–°çš„ playerSquaresIndices å’Œç©ºçš„ marks)
            saveCurrentThemeState(); 

            // é–å®šé¸æ“‡å™¨
            disableSelectors();

            showMessage('ğŸš€ å¿«é€ŸéŠæˆ²å·²é–‹å§‹ï¼ç³»çµ±å·²ç‚ºæ‚¨éš¨æ©Ÿç”¢ç”Ÿ 4x4 è¡¨æ ¼ã€‚', 'success');

            // æ¸²æŸ“éŠæˆ²è¡¨æ ¼
            renderBingoGrid();
        }

        function setupThemeSelector() {
            themeSelector.innerHTML = '';
            for (const id in THEMES) {
                const theme = THEMES[id];
                const option = document.createElement('option');
                option.value = id;
                option.textContent = theme.title;
                themeSelector.appendChild(option);
            }
            themeSelector.value = activeTheme;
            themeTitle.textContent = THEMES[activeTheme].title;
        }
        
        /**
         * æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å‡½å¼
         */
        function initApp() {
            setupThemeSelector(); 
            loadCurrentThemeState(); 
            
            // <-- ä¿®æ­£è™•: ç¢ºä¿åœ¨æª¢æŸ¥éŠæˆ²ç‹€æ…‹å‰ï¼Œå‹åˆ©ç›®æ¨™ä¸‹æ‹‰é¸å–®å·² populated -->
            renderLinesNeededSelector();
            
            themeTitle.textContent = THEMES[activeTheme].title; 

            if (playerSquaresIndices && playerSquaresIndices.length === 16) {
                renderBingoGrid(); // æœƒåœ¨å…§éƒ¨å‘¼å« disableSelectors()
            } else {
                renderSelectionUI(); // æœƒåœ¨å…§éƒ¨å‘¼å« enableSelectors()
            }
            
            // --- ä¿®æ­£ï¼šåœ¨é€™è£¡ç¶å®šäº‹ä»¶ç›£è½å™¨ ---
            if (quickStartButton && !quickStartButton.dataset.listenerAdded) {
                quickStartButton.addEventListener('click', quickStartGame);
                quickStartButton.dataset.listenerAdded = 'true'; // é˜²æ­¢é‡è¤‡ç¶å®š
            }
        }

        window.onload = initApp;
    </script>
</body>
</html>